if (!require('readr')) install.packages('readr')
library(readr)

#通达信自选股格式
#开头：c(0x0d, 0x0a)
#前缀：0x31，沪市，0x30，深市
#代码：6位
#分割：c(0x0d, 0x0a)

#大智慧自选股文件格式
#开头:c(0xa6, 0x00, 0x51, 0xff, 0x01)
#分割:c(0x00, 0x00, 0x00, 0x00, 0xd6, 0x2e, 0x25, 0x59)
#前缀c(0x53, 0x48),SH,SZ,C(0x53, 0x5a)

tdx2dzh<-function(tdx,dzh){
  #初始化
  dzhraw<-c(0xa6, 0x00, 0x51, 0xff, 0x01)
  dzhsh<-c(0x53, 0x48)
  dzhsz<-c(0x53, 0x5a)
  dzhfg<-c(0x00, 0x00, 0x00, 0x00, 0xd6, 0x2e, 0x25, 0x59)
  
  #提取通达信数据
  n<-read_csv(tdx)[[1]]
  lapply(n,function(i,r=dzhraw){
    iraw<-charToRaw(i)
    if (iraw[1] == 0x31) qz<-dzhsh else qz<-dzhsz
    dzhraw<<-c(r,c(qz,tail(iraw,-1),dzhfg))
  })
  write_file(as.raw(dzhraw),dzh)
}

tdx2dzh("e:/dm.blk","e:/dzhdm.txt")